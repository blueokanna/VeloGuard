# Implementation Plan: VeloGuard Rust Codebase Optimization

## Overview

本实现计划将VeloGuard Rust代码库从15个crate优化为5个核心crate，完善所有代理协议实现，确保Flutter-Rust前后端API一致性，并移除未使用的依赖。

## Tasks

- [x] 1. Workspace结构重组和依赖优化
  - [x] 1.1 更新根Cargo.toml，移除未使用的workspace成员
    - 移除console-subscriber, tokio-veloguard-tls, unix-udp-sock, veloguard-sock2proc, veloguard-bin
    - 保留veloguard-core, veloguard-lib, veloguard-dns, veloguard-netstack, veloguard-protocol(新建)
    - _Requirements: 1.5, 2.1-2.5_
  - [x] 1.2 创建veloguard-protocol crate
    - 合并veloguard-quic, veloguard-rustls, veloguard-boringtun, tuic, tuic-quinn
    - 创建统一的协议模块结构
    - _Requirements: 2.2_
  - [x] 1.3 合并veloguard-solidtcp到veloguard-netstack
    - 移动TCP/UDP栈实现到netstack
    - 更新依赖引用
    - _Requirements: 2.3_
  - [x] 1.4 更新所有依赖到最新版本
    - 移除重复依赖(md5 -> md-5, webpki -> rustls内置)
    - 更新smoltcp到正式版本(移除git依赖)
    - _Requirements: 1.3, 1.4_

- [x] 2. 核心宏定义
  - [x] 2.1 创建错误处理宏模块
    - 实现bail_config!, bail_network!, bail_protocol!, bail_dns!宏
    - 实现try_network!, try_protocol!宏
    - _Requirements: 10.1_
  - [x] 2.2 创建配置解析宏模块
    - 实现get_option!, require_option!宏
    - 支持String, u16, bool, Vec<String>类型
    - _Requirements: 10.2_
  - [x] 2.3 创建协议实现宏模块
    - 实现impl_outbound_proxy!宏
    - 实现impl_transport!宏
    - _Requirements: 10.3, 10.4_

- [x] 3. Checkpoint - 确保workspace编译通过
  - 运行cargo check --workspace
  - 确保所有测试通过，如有问题请询问用户

- [x] 4. 通用地址类型实现
  - [x] 4.1 实现Address枚举
    - Domain(String, u16), Ipv4(Ipv4Addr, u16), Ipv6(Ipv6Addr, u16)
    - 实现write_to, read_from, read_from_async方法
    - 实现From<TargetAddr>转换
    - _Requirements: 5.1-5.10_
  - [x] 4.2 编写Address属性测试
    - **Property: Address序列化往返**
    - **Validates: Requirements 11.7**

- [x] 5. Shadowsocks协议完善
  - [x] 5.1 添加UDP relay支持
    - 实现relay_udp方法
    - 实现UDP数据包加解密
    - _Requirements: 5.1, 5.10_
  - [x] 5.2 添加2022加密支持
    - 实现Aes128Gcm2022, Aes256Gcm2022, Chacha20Poly13052022
    - 更新CipherSpec枚举
    - _Requirements: 5.1_
  - [x] 5.3 编写Shadowsocks属性测试
    - **Property: 加密解密往返**
    - **Validates: Requirements 5.1**

- [x] 6. Trojan协议完整实现
  - [x] 6.1 实现TLS连接
    - 使用tokio-rustls建立TLS连接
    - 支持SNI和ALPN配置
    - 支持skip_cert_verify选项
    - _Requirements: 5.2, 6.2_
  - [x] 6.2 实现Trojan握手协议
    - 实现SHA224密码哈希
    - 实现handshake方法
    - 实现TrojanCommand枚举
    - _Requirements: 5.2_
  - [x] 6.3 实现relay_tcp方法
    - 完成TCP数据转发
    - 添加流量统计
    - _Requirements: 5.2_
  - [x] 6.4 实现relay_udp方法
    - 实现UDP over Trojan
    - _Requirements: 5.2, 5.10_

- [x] 7. VMess协议完整实现
  - [x] 7.1 实现VMess头部加密
    - 实现generate_auth_id方法
    - 实现generate_request_key/iv方法
    - 实现seal_header方法
    - _Requirements: 5.3_
  - [x] 7.2 实现VMess数据加密
    - 支持AES-128-GCM, ChaCha20-Poly1305, None, Zero
    - 实现VmessCipher枚举
    - _Requirements: 5.3_
  - [x] 7.3 实现relay_tcp方法
    - 完成VMess TCP转发
    - 实现响应头解密
    - _Requirements: 5.3_
  - [x] 7.4 实现relay_udp方法
    - 实现UDP over VMess
    - _Requirements: 5.3, 5.10_

- [-] 8. VLess协议新增实现
  - [ ] 8.1 创建VLess模块结构
    - 创建vless.rs文件
    - 定义VlessConfig, VlessOutbound结构
    - 添加到OutboundType枚举
    - _Requirements: 5.4_
  - [x] 8.2 实现VLess握手协议
    - 实现handshake方法
    - 实现VlessCommand枚举
    - 实现VlessRequest/VlessResponse结构
    - _Requirements: 5.4_
  - [x] 8.3 实现XTLS-Vision流控
    - 实现VlessFlow枚举
    - 实现Vision流控逻辑
    - _Requirements: 5.4_
  - [x] 8.4 实现relay_tcp和relay_udp方法
    - 完成VLess数据转发
    - _Requirements: 5.4, 5.10_

- [x] 9. Checkpoint - 确保协议实现编译通过
  - 运行cargo check --workspace
  - 确保所有测试通过，如有问题请询问用户

- [x] 10. WireGuard协议完整实现
  - [x] 10.1 实现Noise协议握手
    - 使用veloguard-boringtun中的现有实现
    - 实现handshake方法
    - _Requirements: 5.5_
  - [x] 10.2 实现数据包加解密
    - 实现encrypt_packet, decrypt_packet方法
    - 实现keepalive方法
    - _Requirements: 5.5_
  - [x] 10.3 实现relay_tcp和relay_udp方法
    - 通过WireGuard隧道转发流量
    - _Requirements: 5.5, 5.10_

- [x] 11. TUIC协议完整实现
  - [x] 11.1 实现QUIC连接管理
    - 使用quinn建立QUIC连接
    - 实现TuicConnection结构
    - _Requirements: 5.6_
  - [x] 11.2 实现TUIC认证
    - 实现authenticate方法
    - 支持UUID和密码认证
    - _Requirements: 5.6_
  - [x] 11.3 实现TCP/UDP流
    - 实现open_tcp_stream方法
    - 实现send_udp_packet方法
    - _Requirements: 5.6, 5.10_
  - [x] 11.4 实现relay_tcp和relay_udp方法
    - 完成TUIC数据转发
    - _Requirements: 5.6, 5.10_

- [x] 12. Hysteria2协议完整实现
  - [x] 12.1 实现QUIC连接
    - 正确的修改和优化tuic-quinn中的现有实现
    - 使用quinn建立连接
    - 支持obfs混淆
    - _Requirements: 5.9_
  - [x] 12.2 实现Hysteria2认证
    - 实现authenticate方法
    - 支持带宽控制
    - _Requirements: 5.9_
  - [x] 12.3 实现relay_tcp和relay_udp方法
    - 完成Hysteria2数据转发
    - _Requirements: 5.9, 5.10_

- [x] 13. 传输层实现
  - [x] 13.1 实现TLS Transport
    - 创建TlsTransport结构
    - 支持SNI, ALPN, skip_cert_verify
    - 支持TLS指纹伪装
    - _Requirements: 6.2_
  - [x] 13.2 实现WebSocket Transport
    - 创建WebSocketTransport结构
    - 支持自定义headers和path
    - 支持Early Data
    - _Requirements: 6.4_
  - [x] 13.3 实现HTTP/2 Transport
    - 创建H2Transport结构
    - 支持自定义headers
    - _Requirements: 6.3_
  - [x] 13.4 实现gRPC Transport
    - 创建GrpcTransport结构
    - 支持Gun和Multi模式
    - _Requirements: 6.5_

- [x] 14. Checkpoint - 确保传输层实现编译通过
  - 运行cargo check --workspace
  - 确保所有测试通过，如有问题请询问用户

- [x] 15. 路由系统完善
  - [x] 15.1 实现GeoIP规则匹配
    - 加载GeoIP数据库
    - 实现matches_geoip方法
    - _Requirements: 3.6_
  - [x] 15.2 实现RuleSet规则匹配
    - 实现RuleProvider结构
    - 支持HTTP和File类型
    - 支持Domain, IPCIDR, Classical行为
    - _Requirements: 3.9, 8.1_
  - [x] 15.3 实现ProcessName规则匹配
    - 实现进程名获取(跨平台)

    - _Requirements: 3.8_
  - [x] 15.4 编写路由匹配属性测试
    - **Property 1: 路由规则匹配**
    - **Validates: Requirements 3.1-3.11**

- [x] 16. DNS系统完善
  - [x] 16.1 实现DoH服务器
    - 创建DoH HTTP端点
    - 支持GET和POST方法
    - _Requirements: 4.7_
  - [x] 16.2 实现DoT服务器
    - 创建DoT TLS监听器
    - _Requirements: 4.8_
  - [x] 16.3 实现Bogon IP检测
    - 检测私有IP, 回环IP, 保留IP
    - 实现fallback逻辑
    - _Requirements: 4.9_
  - [x] 16.4 编写DNS属性测试
    - **Property 2: DNS解析往返**
    - **Property 3: Fake-IP分配往返**
    - **Property 4: DNS Bogon检测**
    - **Validates: Requirements 4.9-4.11**

- [x] 17. 动态规则/代理加载
  - [x] 17.1 实现ProxyProvider
    - 支持HTTP和File类型
    - 实现load, update方法
    - 实现health_check方法
    - _Requirements: 8.2, 8.3_
  - [x] 17.2 实现RuleProvider
    - 支持HTTP和File类型
    - 实现load, update, matches方法
    - _Requirements: 8.1, 8.3_
  - [x] 17.3 实现自动更新机制
    - 基于interval定时更新
    - 本地缓存支持
    - _Requirements: 8.3, 8.4_
  - [x] 17.4 编写远程资源加载属性测试
    - **Property 6: 远程资源加载**
    - **Validates: Requirements 8.1-8.5**

- [x] 18. Checkpoint - 确保核心功能编译通过
  - 运行cargo check --workspace
  - 确保所有测试通过，如有问题请询问用户

- [x] 19. Flutter-Rust FFI API实现
  - [x] 19.1 实现代理控制API
    - start_proxy_from_yaml, start_proxy_from_file
    - stop_proxy, is_proxy_running
    - reload_config_from_yaml, reload_config_from_file
    - _Requirements: 11.1_
  - [x] 19.2 实现流量统计API
    - get_traffic_stats
    - get_connections, close_connection, close_all_connections
    - _Requirements: 11.2, 11.3_
  - [x] 19.3 实现代理管理API
    - get_proxies, get_proxy_groups, select_proxy
    - test_proxy_latency, test_all_proxies_latency
    - _Requirements: 11.1_
  - [x] 19.4 实现配置查询API
    - get_rules, get_dns_config
    - set_proxy_mode, get_proxy_mode
    - _Requirements: 11.4_
  - [x] 19.5 实现平台特定API
    - Android: set_vpn_fd, clear_vpn_fd, set_protect_socket_callback
    - Windows: start_tun_mode, stop_tun_mode
    - _Requirements: 11.1_
  - [x] 19.6 编写FFI序列化属性测试
    - **Property 7: FFI序列化往返**
    - **Validates: Requirements 11.1-11.6**

- [x] 20. DTO类型实现
  - [x] 20.1 实现TrafficStatsDto
    - upload, download, total_upload, total_download
    - connection_count, uptime_secs
    - _Requirements: 11.2_
  - [x] 20.2 实现ConnectionDto
    - id, src_addr, dst_addr, dst_domain
    - protocol, outbound, upload, download
    - start_time, rule
    - _Requirements: 11.3_
  - [x] 20.3 实现ProxyInfoDto和ProxyGroupDto
    - tag, protocol_type, server, port, latency_ms, alive
    - group_type, proxies, selected
    - _Requirements: 11.1_
  - [x] 20.4 实现RuleDto和DnsConfigDto
    - rule_type, payload, outbound, matched_count
    - enable, listen, enhanced_mode, nameservers, fallback
    - _Requirements: 11.4_

- [x] 21. Jaeger追踪集成
  - [x] 21.1 实现OpenTelemetry配置
    - 创建init_tracing函数
    - 支持Jaeger endpoint配置
    - _Requirements: 9.1, 9.2_
  - [x] 21.2 添加Span instrumentation
    - DNS解析操作追踪
    - 代理连接建立追踪
    - 路由决策追踪
    - _Requirements: 9.3-9.5_
  - [x] 21.3 实现条件编译
    - 使用feature flag控制追踪
    - 禁用时零开销
    - _Requirements: 9.6_

- [x] 22. 代码清理
  - [x] 22.1 移除所有代码注释
    - 移除TODO注释
    - 移除文档注释(保留pub API文档)
    - _Requirements: 10.5, 12.6_
  - [x] 22.2 移除未使用的代码
    - 移除dead code 和 解决所有的warning和error(不要dead code)
    - 移除未使用的imports
    - _Requirements: 12.3, 12.4_
  - [x] 22.3 整理重复实现
    - 合并重复的工具函数
    - 正确的优化API函数和FFI相关的函数
    - 统一错误处理模式
    - _Requirements: 12.4_

- [x] 23. Final Checkpoint - 完整测试
  - 运行cargo check --workspace
  - 运行cargo test --workspace
  - 运行cargo clippy --workspace
  - 确保所有测试通过，如有问题请询问用户

## Notes

- All tasks are required and must be completed
- Each task references specific requirements for traceability
- Checkpoints ensure incremental validation
- Property tests validate universal correctness properties
- Unit tests validate specific examples and edge cases
- 所有配置使用YAML格式，通过serde_yaml处理
- Flutter和Rust前后端API保持一致
